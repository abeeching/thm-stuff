# Metasploit: Introduction

*Also in: Cyber Security 101 - section 7, room 2*

## [Task 1] Introduction to Metasploit

Metasploit is a commonly-used exploitation framework that can be used for penetration testing, starting from information gathering and going all the way up to post-exploitation activity. There are two main versions of Metasploit:
- Pro: This is the commercial version that facilitates automation and management of tasks, and comes with a GUI.
- Framework: This is the free, open-source version that operates as a CLI. This is the focus of this room, since it is installed on the AttackBox and on commonly-used pentesting distributions of Linux.

The Metasploit Framework is a set of tools that allows you to do information gathering, scanning, exploitation and exploit development, and more. It's primarily used for pentesting, but it can also be helpful for vulnerability research and exploit development. There are three main components:
- `msfconsole`, which is the main command line interface
- Modules, which are supporting utilities for exploits, scanners, payloads, and so on.
- Tools, which help with vulnerability research/assessment and pentesting, including `msfvenom` and `pattern_create`/`pattern_offset`. It's worth exploring these, particularly the latter two, since we'll be covering `msfvenom` down the road.

All work can be done in the AttackBox. The attached VM may be launched to follow along the examples.

## [Task 2] Main Components of Metasploit

You'll be interacting with the Metasploit console primarily; it can be launched by running `msfconsole`. This is the main interface to interact with all the modules of the Metasploit Framework, which are small components that are built to perform some task, e.g. exploiting stuff, scanning targets, brute-forcing...

There are a few recurring concepts and terms you should keep in mind:
- An _exploit_ is code that uses a vulnerability present on the target system.
- A _vulnerability_ is a flaw - design, coding, logical, or otherwise - that affects the target system, the exploitation of which can result in the loss of confidential information or execution of code.
- A _payload_ is the code that will run on a target system as part of an exploit.

There are different types of modules in Metasploit:
- Auxiliary modules include supporting tools such as scanners and crawlers.
- Encoders allow us to encode the exploit and payload in such a way that a signature-based antivirus won't be able to recognize them; this can be hit or miss. Signature-based antiviruses have a database of known threats, and they compare suspicious files to the database and raise an alert if there is a match.
- Evasion modules attempt to directly evade antivirus software, with varying degrees of success.
- Exploit modules are...exploits. They're set up by target system.
- NOPs are _No Operations_ - they do nothing and are represented in Intel x86 CPUs as `0x90`. This makes the CPU do nothing for one cycle. These are often used as a buffer to achieve consistent payload sizes.
- Payloads are codes that run on the target system. There are different types of paylods ranging from those that get us shells to those that run commands (e.g., running `calc.exe` as a benign way of showing we can run apps on a system). Running commands on the target system and (even better) having an interactive connection is important for pentesting.
  - Adapters wrap payloads to convert them to different formats. As an example, a normal payload may be wrapped into a PowerShell adapter, making a single PowerShell command that executes the payload.
  - Singles are self-contained payloads that do not need to download an additional component to run.
  - Stagers set up connections between Metasploit and the target system, and is useful for owrking with staged payloads. The stager is first put on the target system, and then the rest of the payload (stage) is downloaded. This makes the initial size of the payload relatively small.
  - Stages are downloaded by the stager, allowing you to use larger-sized payloads.
- Post modules are used on the final stage of pentesting: post-exploitation.
 
There are a few ways to identify single/inline payloads and staged payloads:
- `generic/shell_reverse_tcp` is an inline/single payload, indicated by the underscore between `shell` and `reverse`.
- `windows/x64/shell/reverse_tcp` is a staged payload, indicated by the slash between `shell` and `reverse`.

Modules can be found in `/opt/metasploit-framework/embedded/framework/modules`.

**[Task 2, Question 1] What is the name of the code taking advantage of a flaw on the target system?** - Exploit

**[Task 2, Question 2] What is the name of the code that runs on the target system to achieve the attacker's goal?** - Payload

**[Task 2, Question 3] What are self-contained payloads called?** - Singles

**[Task 2, Question 4] Is `windows/x64/pingback_reverse/tcp` among singles or staged payload?** - Singles

## [Task 3] Msfconsole

Again, `msfconsole` is used to get into the Metasploit Framework. This can be run in the AttackBox as well as any system that has Metasploit installed on.

The command line will change to `msf6` or `msf5` when run, depending on what versio nof Metasploit is installed. You can use Metasploit as a regular command-line shell with all the regular commands (e.g. `ls`, `ping`, and `clear`). However, some functionality such as output redirection does not work.

You can use `help` in Metasploit Framework to get general information or for more information on a specific command. The `history` command lets you pull up commands you have typed earlier, and you can use tab completion to automatically complete commands and modules.

Msfconsole commands are set up based on context, i.e., set values are for the currently-selected modules unless otherwise defined as a global variable. If you switch to another module, these values are lost.

As an example, we can set up values to use for the EternalBlue exploit (MS17-010). This exploit was designed to target the SMBv1 server on various Windows systems; the Server Message Block (SMB) protocol is used to allow file sharing and sending files to printers in Windows. It was infamously exploited in the WannaCry ransomware attack of 2017.

Run `use exploit/windows/smb/ms17_010_eternalblue` to select the module. If you ever need to switch out of this context, simply run the `back` command. To get more information on the module, run `info`. Generally, if you know the path of the module, you can run `info (PATH)` to get more information about it from any context.

You can still use commands that are previously mentioned. You can see the options available in this current module/context by running `show options`.

Certain options need to be set - these are noted as being _required_. What settings are required will vary from module to module; exploit modules may need the `RHOSTS` and `RPORT` values to be set, among others. Post-exploitation modules may just need `SESSION` (Session ID) to be set.

To see payloads that can eb used in any context, run `show payloads`. If `show` is run from the msfconsole prompt on its own, you'll just see all modules.

To search for modules, run `search (KEYWORD)`. The keyword can include CVE numbers, exploit names, and target systems. You'll get overviews of the available modules, the type of module, and the category of module (e.g., if it is a scanner, something for Windows, something for Unix, etc.). You can use any module returned in a search result by running `use (NUMBER_OF_SEARCH_RESULT)`. You'll also get information about the module's reliability; see its "rank":
- ExcellentRanking: Exploit does not crash the service. Tends to be the case for SQL injection, command execution, file inclusion, and so on. Typically excludes memory corruption exploits.
- GreatRanking: Exploit has a default target and either auto-detects the appropriate target or uses an app-specific return address after a version check.
- GoodRanking: Exploit has a default tarrget and is the "common case" for this type of software.
- NormalRanking: Exploit is otherwise reliable, but depends on a specific version and cannot reliably autodetect.
- AverageRanking: Generally unreliable, difficult to exploit.
- LowRanking: Exploit nearly impossible to exploit (< 50% success rate) for common platforms.
- ManualRanking: Unstable, difficult to exploit, effectively leads to denial of serice. Also applies to modules that have no use unless specifically configured by the user.

Be aware that exploits take advantage of vulnerabilities on a target system - this naturally leads to unnatural or unexpected behavior occurring on a target. Low-ranking exploits may well work fine, whereas excellent exploits may just crash the system.

When searching, you can filter by types of modules with the `type:(TYPE)` command. The types include auxiliary, encoders, etc... the stuff from Task 2. 

**[Task 3, Question 1] How would you seach for a module related to Apache?** - `search apache`

And now we'll start using Metasploit. Launching it by running `msfconsole`, we can look for information on the `ssh_login` module by running `info auxiliary/scanner/ssh/ssh_Login`. This tells us who provided the module, among other things:

![image](https://github.com/user-attachments/assets/9a34a538-11b8-4133-b06f-6554bc411bde)

**[Task 3, Question 2] Who provided the `auxiliary/scanner/ssh/ssh_login` module?** - `todb`

## [Task 4] Working with Modules

The examples provided in the room should work for Metasploit versions 5 and 6; these are typically what's installed in a system with Metasploit. When you have entered the context of a module with the `use (MODULE)` command, you will need to set parameters. Certain parameters will be required, as mentioned eariler; this will vary. Run `show options` to see what has to be set. To set a parameter value, run the command `set (PARAMETER_NAME) (VALUE)`.

Make sure you are in the correct context before running commands. Check your command prompt input line:
- If you don't see `msf5` or `msf6` or something similar, you are in your regular command prompt; Metasploit commands do not work here.
- If you see `msf6 >` or something similar, you are in `msfconsole` and need to set a specific context before you can use context-specific commands.
- If you see `msf6 exploit(MODULE_PATH) > ` or something similar, you are now working on a proper context and can issue context-specific commands.
- If you see `meterpreter >`, you are in the Meterpreter prompt, which is an important payload! This allows you to interact with the target system, and so you can use Meterpreter commands here.
- If you see a system's command prompt input line (e.g. `C:\Windows\system32>`) after running Metasploit and exploiting the system, the exploit has been completed and you can issue standard OS commands against the target system.

Some parameters need a value for the exploit to work; some values will be pre-populated, but you should make sure that they apply in your specific situation. A web exploit may have `RPORT` (remote port on the target system) set to `80` for HTTP servers; you may be attacking a web server on port `8080` and need to change this. When all values have been set, check by running `show options`.

These are the most common parameters:
- `RHOSTS`, for remote hosts. This can be a single IP address or a network range, and can also support Classless Inter-Domain Routing notation (CIDR notation, e.g. `IP/24`). You can also include a file of targets, with each target IP per line.
- `RPORT`, for remote ports.
- `PAYLOAD`, for the payload that you will use with the exploit.
- `LHOST`, for the local host - the attacking machine. This will be your AttackBox or Kali IP address.
- `LPORT`, for the local port. This is how payloads/shells will communicate from the target system back to your machine, and can be any port number that isn't currently used by any other application.
- `SESSION`, for the Meterpreter/Metasploit session number. Every connection established to the target system with Metasploit has a session ID, and this is primarily used in post-exploitation omdules.

To unset parameter values, run `unset`. You can clear all set parameters with `unset all`. If you want to set options that are used for all modules, run `setg`. This lets you set the value so it can be used by default across different modules. You can clear these values with `unsetg`.

To use a module, issue the `exploit` command, or use the `run` command. You can use it without parameters, or you can run `exploit -z` to run the exploit in the background. Some commands have the `check` command that allows you to see if the target system is vulnerable without exploiting it.

When a vulnerability has been successfully exploited, a session is created to allow for communication between the target and attacker machines. You can use the `background` command in a Meterpreter prompt to send the session to the background and return to `msfconsole`. You can also background the session by pressing `CTRL + Z`. You can run `sessions` to see a list of sessions, and then run `sessions -i (SESSION_NUMBER)` to interact with that particular session.

**[Task 4, Question 1] How would you set the LPORT value to 6666?** - `set LPORT 6666`

**[Task 4, Question 2] How would set the global value for RHOSTS to `10.10.19.23`?** - `setg RHOSTS 10.10.19.23`

**[Task 4, Question 3] What command would you use to clear a set payload?** - `unset PAYLOAD`

**[Task 4, Question 4] What command do you use to proceed with the exploitation phase?** - `exploit`

## [Task 5] Summary

Metasploit helps faciltiate the exploitation process by providing an easy place to find, customize, and run an exploit. There are many modules that can be used throughout the exploitation process, and this room is designed to give a basic overview and example of using Metasploit. The following rooms cover Metasploit's use and its components in more detail.
