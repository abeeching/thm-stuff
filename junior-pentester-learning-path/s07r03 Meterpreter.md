# Metasploit: Meterpreter

*Also in: Cyber Security 101 - section 7, room 4*

## [Task 1] Introduction to Meterpreter

Meterpreter is a special Metasploit payload that supports pentesting with various components. It runs on the target system and acts as an agent in a command and control (C2) architecture. You can use it to interact with the target OS and files, as we saw in the previous room. There's also specialized commands that we can run to do certain pentesting tasks.

Meterpreter runs on the target system, but is not installed on it - it simply runs in memory. This is done to prevent it from being detected during antivirus scans, since most antivirus software will scan new files on the disk when downlaoded. To this end, Meterpreter hangs out in RAM, and so it'll only be seen as a running process.

Meterpreter also uses encrypted TLS comunication with the server where Metasploit runs to prevent being caught by network-based intrusion prevention and detection systems (IPS, IDS). If the target organization does not decrypt and inspect the traffic coming to and going out of the local network, an IPS and IDS would not be able to detect activities.

Unfortunately, in spite of all of thisMeterpreter is generally recognized by major antivirus software. That said, there's some degree of stealth involved in using Meterpreter. It's hard to tell with conventional commands what processes are using Meterpreter -- even checking the dynamic link libraries (DLLs) in use doesn't help. Meterpreter detection methods go beyond the scope of this room, but the key takeaways is that
1. Meterpreter does what it can to stay hidden.
2. Meterpreter often gets caught by antivirus software anyway.

## [Task 2] Meterpreter Flavors

Metasploit payloads are split into two categories: inline (single) and staged. Staged payloads are sent to the target in two steps - an initial part is installed, the stager, and this part requests the rest of the payload. This leads to a smaller payload size. Inline payloads are just sent in a single step. This applies even to Meterpreter payloads, though Meterpreter has a lot of different versions to choose from based on the target operating system.

You can see what kind of flavors are available by running `msfvenom --list payloads | grep meterpreter`. Meterpreter versions are available for Android, iOS, Java, Linux, OSX, PHP, Python, Windows, among others.

Your decision on which version to use will be based on the following:
- The target OS in use
- Components available on the target OS (e.g. Python, PHP)
- Network connectivity with the target (e.g., TCP, HTTPS reverse connections, IPv6, etc.)

If not using Meterpreter as a standalone payload generated by `msfvenom`, you'll be limited by the exploit. Most exploits have a default Meterpreter payload, though you can always check payload options by running `show payloads`.

## [Task 3] Meterpreter Commands

You can view all commands by running `help`. Every version of Meterpreter has different command options. Commands are built-in tools available in Meterpreter, and run on the target system without loading additional script and executable files. You have three major categories of tools: built-in commands, Meterpreter tools, Meterpreter scripts.

The categories and commands as called out by Meterpreter (at least for `windows/x64/meterpreter/reverse_tcp`) are:
- Core commands
  - `background` puts the current session in the background
  - `exit` terminates the Meterpreter session
  - `guid` gets the globally unique identifier
  - `help` displays the help menu
  - `info` displays information about a module
  - `irb` opens an interactive Ruby shell in the current session
  - `load` loads one or more Meterpreter extensions
  - `migrate` allows you to move Meterpreter to another process
  - `run` lets you execute a Meterpreter script or post module
  - `sessions` allows you to quickly change to another session.
- Filesystem commands
  - `cd` changes directory
  - `ls` lists all files in the current directory; `dir` also works
  - `pwd` prints the current working directory
  - `edit` lets you edit a file
  - `cat` shows the contents of a file to the screen
  - `rm` deletes the specified file
  - `search` searches for files
  - `upload` uploads aa file or directory
  - `download` downloads a file or directory
- Networking commands
  - `arp` displays the Address Resolution Protocol cache
  - `ifconfig` displays network interfaces available on the target
  - `netstat` displays network connections
  - `portfwd` forwards a local port to a remote serice
  - `route` lets you view and modify the routing table
- System commands
  - `clearev` clears the event logs
  - `execute` executes a command
  - `getpid` shows the current process identifier
  - `getuid` shows the user that Meterpreter is running as
  - `kill` terminates a process
  - `pskill` terminates processes by name
  - `ps` lists running processes
  - `reboot` reboots the remote computer
  - `shell` drops into a system command shell
  - `shutdown` shuts the remote computer down
  - `sysinfo` gets information about the remote computer
- User interface commands
- Webcam commands
- Audio output commands
- Elevate commands
- Password database commands
- Timestomp commands

Other commands that appear throughout the categories above include:
- `idletime` which returns the number of seconds the user has been idle for
- `keyscan_dump` dumps the keystroke buffer
- `keyscan_start` starts capturing keystrokes
- `keyscan_stop` stops capturing keystrokes
- `screenshare` lets you watch the remote user's desktop in real time
- `screenshot` lets you screenshot the interactive desktop
- `record_mic` records audio from the default microphone for `x` seconds
- `webcam_chat` starts a video chat
- `webcam_list` lists all webcams
- `webcam_snap` takes a snapshot from the specified webcam
- `webcam_stream` plays a video stream from the specified webcam
- `getsystem` attempts to elevate your privileges to that of the local system
- `hashdump` dumps the contents of the SAM database for Windows

Note that these commands may not all work, depending on how the target system is set up.

## [Task 4] Post-Exploitation with Meterpreter

Here's some more information about some commands listed above that we can use for post-exploitation activity:
- `help`, again, lists all available commands in Meterpreter. It's worth checking this, since what's available to you depends on the Meterpreter version.
- `getuid` displays the user with which Meterpreter is running, and gives you a good idea of what kind of privileges you have on the target system.
- `ps` lists running processes, including PID information. This can be used to help with migrating Meterpreter.
- `migrate (PID)` lets you migrate Meterpreter to another process. This can affect what kind of information Meterpreter can pick up; for instance, if a word processor is running and you migrate to that, you can capture keystrokes. Migrating may stabilize Meterpreter and make life easier for you. You may lose your privileges without being able to gain them back; be warned.
- `hashdump` lists the contents of the SAM database, which stores user passwords on Windows. This is all in the NTLM format. You may be able to brute-force them or use them in other attacks, such as pass-the-hash attacks.
- `search` lets you locate files with potentially juicy information; this may be used to find certain files in CTFs, as well as files that may contain password and account information.
- `shell` lets you launch a regular command line in the target system. Pressing CTRL + Z sends you back into Meterpreter.

## [Task 5] Post-Exploitation Challenge

Now we start a VM and do some work in there. We'll also need to start the AttackBox to make use of Meterpreter. In summary:
- Meterpreter is a good tool for privilege escalation and lateral movement.
- Meterpreter can be used for post-exploitation.
- You can load additional tools like Kiwi and Python as needed.

Our goal in post-exploitation is to get more information about the target, look for interesting files and information, escalate privileges, and perform lateral movement.

If you load a new tool with the `load` command, you will get new options in the `help` menu. These change depending on the menu, of course.

We now need to use Meterpreter against the VM. We'll assume that we managed to exploit SMB somehow - `exploit/windows/smb/psexec` - and got credentials. The username that we'll use to simulate this is `ballen` for the username and `Password1` for the password.

The process of exploiting the vulnerability with Metasploit is straightforward. User the right module, set the RHOSTS, SMBUser, and SMBPass values, and then launch the exploit.

![image](https://github.com/user-attachments/assets/e1995871-4700-47e6-be5a-063935844685)

Once we get into the system, we can examine information about the system by running `sysinfo`:

![image](https://github.com/user-attachments/assets/caf03e01-49f0-4b8f-bb5e-fa608e0fefda)

**[Task 5, Question 1] What is the computer name?** - ACME-TEST

If we wanted to get information about the domain, we'll have to background Meterpreter by pressing CTRL + Z. We'll use the `post/windows/gather/enum_domain` module to get information about the domain. We need to set the `SESSION` value to our Meterpreter session, and then run the utility to get information:

![image](https://github.com/user-attachments/assets/fb36bb71-9ed9-49ca-a92b-1e14ac99ed04)

**[Task 5, Question 2] What is the target domain?** - `FLASH`

To get information about user shares, we'll run `post/windows/gather/enum_shares` and set `SESSION` to 1. I decided to run `setg SESSION 1` so that I wouldn't have to set this value later. Running the module gives the following information:

![image](https://github.com/user-attachments/assets/12ddb0e5-a3ea-48a3-9749-8814ff60830c)

SYSVOL and NETLOGON are both system shares; the last one in the list appears to be the one that was made by the user.

**[Task 5, Question 3] What is the name of the share likely created by the user?** - `speedster`

Now let's return to Meterpreter and grab some hashes. We'll run `sesssions -i 1` to get back into our session. Then we'll need to migrate into `lsass.exe` to dump credentials. When we run `ps` in Meterpreter, we have the following information:

![image](https://github.com/user-attachments/assets/3ebbea3e-515d-4d68-a6eb-39b07d4eba4b)

We can try running `migrate 768` to get Meterpreter into `lsass.exe`. This _might_ differ from the values you see in your virtual machine. If the migration completes, we can run `hashdump` to get the hashes. Again, the password hash is the last set of characters (highlighted in the screenshot):

![image](https://github.com/user-attachments/assets/10ebe163-64bb-48b0-b89e-d3a8c61d5e92)

**[Task 5, Question 4] What is the NTLM hash of the `jchambers` user?** - 69596c7aa1e8daee17f8e78870e25a5c

We can go ahead and try to crack this hash with, say, Crackstation. Turns out that we _can_ get the cleartext password:

![image](https://github.com/user-attachments/assets/1a75b440-39b9-4ceb-99e7-d3a82d2bc15a)

**[Task 5, Question 5] What is the cleartext password of the `jchambers` user?** - `Trustno1`

Now let's look for some interesting files. We're told to find `secrets.txt`, so we'll have to run `search -f secrets.txt`:

![image](https://github.com/user-attachments/assets/8852f72d-3308-453b-82d2-346ba288b63a)

**[Task 5, Question 6] Where is the `secrets.txt` file located? (Full path of the file)** - `C:\Program Files (x86)\Windows Multimedia Platform\secrets.txt`

We'll go ahead and read the file with `cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt"` - note the capitalization and syntax. If you don't type it like this Meterpreter will not actually display the contents of the file:

![image](https://github.com/user-attachments/assets/a406799e-1145-45d9-8830-981d0723dc66)

**[Task 5, Question 7] What is the Twitter password reevaled in the `secrets.txt` file?** - `KDSvbsw3849!`

There's another interesting file to look for: `search -f realsecret.txt`.

![image](https://github.com/user-attachments/assets/7d33ac04-2f36-4b43-88c1-85326a364035)

**[Task 5, Question 8] Where is the `realsecret.txt` file located? (Full path of the file)** - `C:\inetpub\wwwroot\realsecret.txt`

And then we run `cat "c:\inetpub\wwwroot\realsecret.txt"` to get the file contents:

![image](https://github.com/user-attachments/assets/1c02ee85-fc66-4227-85c3-fe8826f31b94)

**[Task 5, Question 9] What is the real secret?** - The Flash is the fastest man alive

(As an aside: The _Blue_ room that follows this in the Cyber Security 101 path is in the Offensive Pentesting learning path.)
