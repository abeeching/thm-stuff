# Monday Monitor

## [Task 1] Navigate Through the Endpoint Logs

In this room, we'll practice some of the log analysis stuff we've covered in the previous several rooms. Here, we're investigating the logs generated by an endpoint at a fintech company, specifically on April 29th, 2024 from 12:00 to 20:00. We'll need to investigate the information found in the Wazuh instance provided in the room. This can all be done within a web browser - no VM needed.

After signing into the Wazuh instance, we go to Wazuh -> Modules -> Security Events, we can click the Save icon to the left of the search bar to pull up a list of saved queries. Then you can select Monday_Monitor to access the relevant data. Note that we'll need to set the timeframe accordingly -- we need to set it to be April 29th, 2024 @ 12:00 to April 29th, 2024 @ 20:00.

![image](https://github.com/user-attachments/assets/4d01acb3-daad-49cd-9115-6be3c3b48b82)

Now let's get to work. First, we are told that a downloaded file was used for initial access, and we'd like to know what it was. One place to start looking would be to examine command line entries -- certain command line utilities can be used to download a file from the internet. To add command-line entries to the columns, you can hit the blue + button next to `data.win.eventdata.commandLine` in the left-hand pane. This displays all of the associated command line values. You can even go further... you see all those empty fields in the column? Click the "Add filter" button -- it is just below the search bar. We're going to look for the field `data.win.eventdata.commandLine`, and we're specificaly making sure that it `exists` - set this as the operator. After skimming through these entries, we do see one that stands out: a file was downloaded with PowerShell.

![image](https://github.com/user-attachments/assets/68984e79-e02b-456e-a10d-decf97dcc9ab)

Despite this question's wording, we are concerned with what the name of the file on the server - not what it was named to once downloaded.

**[Task 1, Question 1] Initial access was established using a downloaded file. What is the file name saved on the host?** - `SwiftSpend_Financial_Expenses.xlsm`

Now let's see... our next step is to begin investigating a scheduled task. If a scheduled task was created from a command line, it's likely that the creator would have to use `schtasks.exe` to get the job done. So, we can look up that specific file in the Wazuh search bar. Doing so gives us this, assuming you have the `data.win.eventdata.commandLine` column still visible:

![image](https://github.com/user-attachments/assets/06d6eece-0442-4aec-a2f8-97aa950ab83f)

**[Task 1, Question 2] What is the full command run to create a scheduled task?** - `\"cmd.exe\" /c \"reg add HKCU\\SOFTWARE\\ATOMIC-T1053.005 /v test /t REG_SZ /d cGluZyB3d3cueW91YXJldnVsbmVyYWJsZS50aG0= /f & schtasks.exe /Create /F /TN \"ATOMIC-T1053.005\" /TR \"cmd /c start /min \\\"\\\" powershell.exe -Command IEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((Get-ItemProperty -Path HKCU:\\\\SOFTWARE\\\\ATOMIC-T1053.005).test)))\" /sc daily /st 12:34\"`

From this command, we can gleam a few things. The timing of the scheduled task is given by the parameters at the end of the command - `sc` tells us how often the task runs, and `st` tells us the time at which it runs. Hence, the task must run at `12:34` daily.

**[Task 1, Question 3] What time is the scheduled task meant to run?** - `12:34`

It's likely that this next question refers to the encoded string in the scheduled task command, i.e. `cGluZyB3d3cueW91YXJldnVsbmVyYWJsZS50aG0=`. This string is then saved into the registry as `ATOMIC-T1053.005`. The scheduled task itself will launch PowerShell and run the command stored at that registry key, but first it needs to convert the string from base64. So, we'll want to do the same ourselves and decode this base64 string. Using an online encoder, we get:

![image](https://github.com/user-attachments/assets/142397f3-facc-4ebf-af10-d16a4603ac1d)

**[Task 1, Question 4] What was encoded?** - `ping youarevulnerable.thm`

Now we are looking at user account creation events. The verbiage of the question insinuates that we would be looking for event IDs indicating user account creation, but this is not in fact the case. Trying to directly find events this way doesn't provide much help. The next best thing we can do is investigate the commands that were run. Typically when you want to add or modify a user account via the command line, you will be doing it with `net.exe` (or perhaps just `net`, e.g. `net user add ...`). Either way, this suggests that we should look up `net` in the Wazuh interface and look at command line entries, so let's do so. These commands are pretty interesting:

![image](https://github.com/user-attachments/assets/0efd75e0-f057-4e70-84a1-5ea76881c460)

Specifically, the third and fourth commands are used to assign or change a password for the given user. So this tells us what the password would be:

**[Task 1, Question 5] What password was set for the new user account?** - `I_AM_M0NIT0R1NG`

There probably are other tools out there that can be used for credential dumping, but we can start by looking for the commmon ones. Perhaps the most common tool used for this purpose is Mimikatz. If you look it up in the events, you'll actually see a few entries come up:

![image](https://github.com/user-attachments/assets/c1f7a2e0-35c2-4b0d-94a6-e3413b906d13)

This does NOT mean that the name of the file used is `mimikatz`. In fact, only the first two commands displayed in that screenshot actually involve passwords and credentials being extracted. So, we'll want the name used in _those_ commands to do the job.

**[Task 1, Question 6] What is the name of the .exe that was used to dump credentials?** - `memotech.exe`

Lastly, we'll want to find the flag included in some exfiltrated data. There are different ways to send data out - you could post it to another website or transfer it off the machine. If the data was posted onto a website, there could be a HTTP POST request in the logs. You can look up "post" and, as it would turn out, that's exactly what happened.

![image](https://github.com/user-attachments/assets/98113ddc-34aa-4813-a923-513e58d9c702)

The flag is prefixed with `THM`. Incidentally, you _could_ just search for "THM" in the logs since that's a pretty common way flags are done on this website, but that feels a little unsatisfying to me and not guaranteed to work (some rooms have used "FLAG" as their prefix in the past, I believe, and others simply don't use the prefixes). Also incidentally, you could find this flag pretty easily if you sorted the logs by time in descending order. It would make sense for the data exfiltration stuff to be towards the end of the logs chronologically, but in a real-life situation logs aren't always this nice, so I wanted to highlight an alternative thought process that could get you the answer to this question.

**[Task 1, Question 7] Data was exfiltrated from the host. What was the flag that was part of the data?** - `THM{M0N1T0R_1$_1N_3FF3CT}`
